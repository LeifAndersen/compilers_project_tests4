#lang racket

(require racket/mpair)

(define-syntax (program stx)
  (syntax-case stx ()
    [(_ defs ... exp)
     (with-syntax ([$halt (datum->syntax #'exp '$halt)])
       #'(call/ec (λ ($halt) defs ... exp)))]))



;; Data structures.
(define-syntax dict
  (syntax-rules ()
    [(_ (k v) ...)
     ; =>
     (make-hash (list (cons k v) ...))]))

(define dict? hash?)
(define dict-ref hash-ref)
(define dict-set! hash-set!)

(define-syntax tuple
  (syntax-rules ()
    [(_ v ...)
     ; =>
     (vector v ...)]))

(define tuple-ref vector-ref)
(define tuple-set! vector-set!)
(define tuple? vector?)


(define (mlist-set! mlst n value)
  (cond
    [(null? mlst)  (error "mlist-set! -- index too high")]
    [(= n 0)       (set-mcar! mlst value)]
    [else          (mlist-set! (mcdr mlst) (- n 1) value)]))

(define (mlist-remove! mlst n)
  (cond
    [(null? mlist) (error "cannot delete from empty list")]
    [(= n 1)       (set-mcdr! mlst (mcdr (mcdr mlst)))]
    [else          (mlist-remove! (mcdr mlst) (- n 1))]))

     
(define-struct py-list ([mlist #:mutable]))

(define (py-list-set! pl i val)
  (mlist-set! (py-list-mlist pl) i val))

(define (py-list-ref pl i)
  (mlist-ref (py-list-mlist pl) i))

(define (py-list-remove! pl i)
  (cond
    [(< i 0)  (error "index out of bounds for removal")]
    [(= i 0)  (set-py-list-mlist! (mcdr (py-list-mlist pl)))]
    [else     (mlist-remove! (py-list-mlist pl) i)]))
     
(define (py-list* . args)
  (py-list (list->mlist args)))

;; Iterators.
(define (for-list-k lst f k)
  (letrec ([loop (λ (lst)
    (if (null? lst)
        (k (void))
        (f (car lst) (λ (_)
          (loop (cdr lst))))))])
    (loop lst)))
  
(define (set->list set)
  (for/list ([v set]) v))

(define (tuple->list tuple)
  (for/list ([v tuple]) v))

(define (py-list->list lst)
  (for/list ([v (py-list-mlist lst)]) v))

(define (dict->keys dict)
  (for ([(k _) dict]) k))


(define (for-set-k set f k)
  (for-list-k (set->list set) f k))
  
(define (for-tuple-k tuple f k)
  (for-list-k (tuple->list tuple) f k))
  
(define (for-py-list-k py-list f k)
  (for-list-k (py-list->list py-list) f k))

(define (for-dict-k dict f k)
  (for-list-k (dict->keys dict) f k))



         

;; Operators.
(define (<< a n) (arithmetic-shift a n))
(define (>> a n) (arithmetic-shift a (- n)))

(define (not-equal? a b)
  (not (equal? a b)))

(define-syntax (define/return stx)
  (syntax-case stx ()
    [(_ f-params body ...)
     ; =>
     (with-syntax ([return (datum->syntax #'f-params 'return)])
     #'(define f-params (call/ec (λ (return) body ...))))]))
  
(define/return (in? needle haystack)
  (cond
    [(hash? haystack)     (for ([(x y) haystack])
                            (when (equal? x needle)
                              (return #t)))]
    [(py-list? haystack)  (return (in? needle (py-list-mlist haystack)))]
    [else                 (for ([x haystack])
                            (when (equal? x needle) 
                              (return #t)))])
  #f)
        
(define not-in? (λ (needle haystack) (not (in? needle haystack))))


;; Special variables
(define None 'None)
(define Ellipsis 'Ellipsis)



;; Variable mutation:
(define-syntax set-then!
  (syntax-rules ()
    [(_ var exp next)
     (begin
       (set! var exp)
       next)]))



;; Library functions.

(define bitwise-or bitwise-ior)

(define (py-object->string o)
  
  (define (commas seq)
    (define first? #t)
    (define ans "")
    (for ([c seq])
      (when (not first?)
        (set! ans (string-append ans ", ")))
      (when first?
        (set! first? #f))
      (set! ans (string-append ans (py-object->string c))))
    ans)
    
  (define (keyvals seq)
    (define first? #t)
    (define ans "")
    (for ([(k v) seq])
      (when (not first?)
        (set! ans (string-append ans ", ")))
      (when first?
        (set! first? #f))
      (set! ans (string-append ans (py-object->string k) ": " (py-object->string v))))
    ans)
    
  
  (cond
    [(py-list? o)   (format "[~a]" (commas (py-list-mlist o)))]
    [(tuple? o)     (format "(~a)" (commas o))]
    [(dict? o)      (format "{~a}" (keyvals o))]
    [(string? o)    (format "~v" o)] 
    [else           (format "~a" o)]))

(define (py-print x) 
  (cond 
    [(string? x)  (display x)]
    [else         (display (py-object->string x))])
  (newline))


;; CPS-ify primitives:
(define (cps proc)
  (λ args
    (match args
      [`(,real-args ... ,cont)
       (cont (apply proc real-args))])))

; -- 

(program
 (define break (void))
 (define return (void))
 (define continue (void))
 (define $current-handler (void))
 (define g$x (void))
 (define g$y (void))
 (define g$a (void))
 (set-then!
  g$x
  (py-list* 1 5 1 43 2 6 2 95 10 0 5 4)
  (set-then!
   g$y
   (py-list* "bob" "bar" "billy")
   (set-then!
    g$a
    (lambda (k16)
      ((lambda (f cc) (f (lambda (x k) (cc x)) cc))
       (lambda (return k17)
         ((lambda (i j k18)
            ((cps equal?)
             5
             3
             (lambda (rv19)
               (if rv19
                 ((lambda (k20) (k20 (void))) k18)
                 ((cps modulo)
                  99
                  50
                  (lambda (rv21)
                    ((cps <)
                     5
                     rv21
                     (lambda (rv22)
                       (if rv22
                         ((lambda (k23)
                            ((lambda (f cc) (f (lambda (x k) (cc x)) cc))
                             (lambda (break k24)
                               ((lambda ($seq16 $loop17 k25)
                                  ((lambda (k26)
                                     ((cps set?)
                                      $seq16
                                      (lambda (rv28)
                                        (if rv28
                                          (for-set-k $seq16 $loop17 k26)
                                          ((cps tuple?)
                                           $seq16
                                           (lambda (rv29)
                                             (if rv29
                                               (for-tuple-k $seq16 $loop17 k26)
                                               ((cps py-list?)
                                                $seq16
                                                (lambda (rv30)
                                                  (if rv30
                                                    (for-py-list-k
                                                     $seq16
                                                     $loop17
                                                     k26)
                                                    ((cps dict?)
                                                     $seq16
                                                     (lambda (rv31)
                                                       (if rv31
                                                         (for-dict-k
                                                          $seq16
                                                          $loop17
                                                          k26)
                                                         (k26
                                                          (void)))))))))))))))
                                   (lambda (rv27) (k25 (void)))))
                                g$x
                                (lambda (i16 k32)
                                  ((lambda (f cc) (f (lambda (x k) (cc x)) cc))
                                   (lambda (continue k33)
                                     (set-then!
                                      i
                                      i16
                                      ((lambda (k34)
                                         ((cps py-print)
                                          i
                                          (lambda (rv35)
                                            ((cps modulo)
                                             i
                                             2
                                             (lambda (rv36)
                                               ((cps equal?)
                                                rv36
                                                0
                                                (lambda (rv37)
                                                  (if rv37
                                                    ((lambda (k38)
                                                       ((lambda (e18 k39)
                                                          ((cps modulo)
                                                           i
                                                           2
                                                           (lambda (rv44)
                                                             ((lambda (i17 k40)
                                                                ((cps py-list?)
                                                                 e18
                                                                 (lambda (rv41)
                                                                   (if rv41
                                                                     ((cps
                                                                       py-list-ref)
                                                                      e18
                                                                      i17
                                                                      k40)
                                                                     ((cps
                                                                       tuple?)
                                                                      e18
                                                                      (lambda (rv42)
                                                                        (if rv42
                                                                          ((cps
                                                                            tuple-ref)
                                                                           e18
                                                                           i17
                                                                           k40)
                                                                          ((cps
                                                                            dict?)
                                                                           e18
                                                                           (lambda (rv43)
                                                                             (if rv43
                                                                               ((cps
                                                                                 dict-ref)
                                                                                e18
                                                                                i17
                                                                                k40)
                                                                               (error
                                                                                "cannot index object"
                                                                                k40)))))))))))
                                                              rv44
                                                              k39))))
                                                        g$y
                                                        (lambda (rv45)
                                                          ((cps py-print)
                                                           rv45
                                                           k38))))
                                                     k34)
                                                    (k34 (void))))))))))
                                       k33)))
                                   k32))
                                k24))
                             (lambda (rv46)
                               (set-then!
                                i
                                0
                                ((lambda (f cc) (f (lambda (x k) (cc x)) cc))
                                 (lambda (break k47)
                                   ((lambda ($seq18 $loop19 k48)
                                      ((lambda (k49)
                                         ((cps set?)
                                          $seq18
                                          (lambda (rv51)
                                            (if rv51
                                              (for-set-k $seq18 $loop19 k49)
                                              ((cps tuple?)
                                               $seq18
                                               (lambda (rv52)
                                                 (if rv52
                                                   (for-tuple-k
                                                    $seq18
                                                    $loop19
                                                    k49)
                                                   ((cps py-list?)
                                                    $seq18
                                                    (lambda (rv53)
                                                      (if rv53
                                                        (for-py-list-k
                                                         $seq18
                                                         $loop19
                                                         k49)
                                                        ((cps dict?)
                                                         $seq18
                                                         (lambda (rv54)
                                                           (if rv54
                                                             (for-dict-k
                                                              $seq18
                                                              $loop19
                                                              k49)
                                                             (k49
                                                              (void)))))))))))))))
                                       (lambda (rv50) (k48 (void)))))
                                    g$x
                                    (lambda (i19 k55)
                                      ((lambda (f cc)
                                         (f (lambda (x k) (cc x)) cc))
                                       (lambda (continue k56)
                                         (set-then!
                                          j
                                          i19
                                          ((lambda (k57)
                                             ((lambda (k58)
                                                ((lambda (e21 k61)
                                                   ((lambda (i20 k62)
                                                      ((cps py-list?)
                                                       e21
                                                       (lambda (rv63)
                                                         (if rv63
                                                           ((cps py-list-ref)
                                                            e21
                                                            i20
                                                            k62)
                                                           ((cps tuple?)
                                                            e21
                                                            (lambda (rv64)
                                                              (if rv64
                                                                ((cps
                                                                  tuple-ref)
                                                                 e21
                                                                 i20
                                                                 k62)
                                                                ((cps dict?)
                                                                 e21
                                                                 (lambda (rv65)
                                                                   (if rv65
                                                                     ((cps
                                                                       dict-ref)
                                                                      e21
                                                                      i20
                                                                      k62)
                                                                     (error
                                                                      "cannot index object"
                                                                      k62)))))))))))
                                                    i
                                                    k61))
                                                 g$x
                                                 (lambda (rv66)
                                                   ((cps modulo)
                                                    rv66
                                                    2
                                                    (lambda (rv67)
                                                      ((cps equal?)
                                                       rv67
                                                       0
                                                       (lambda (rv68)
                                                         (if rv68
                                                           ((lambda (k69)
                                                              ((lambda (e23
                                                                        k70)
                                                                 ((lambda (e25
                                                                           k75)
                                                                    ((lambda (i24
                                                                              k76)
                                                                       ((cps
                                                                         py-list?)
                                                                        e25
                                                                        (lambda (rv77)
                                                                          (if rv77
                                                                            ((cps
                                                                              py-list-ref)
                                                                             e25
                                                                             i24
                                                                             k76)
                                                                            ((cps
                                                                              tuple?)
                                                                             e25
                                                                             (lambda (rv78)
                                                                               (if rv78
                                                                                 ((cps
                                                                                   tuple-ref)
                                                                                  e25
                                                                                  i24
                                                                                  k76)
                                                                                 ((cps
                                                                                   dict?)
                                                                                  e25
                                                                                  (lambda (rv79)
                                                                                    (if rv79
                                                                                      ((cps
                                                                                        dict-ref)
                                                                                       e25
                                                                                       i24
                                                                                       k76)
                                                                                      (error
                                                                                       "cannot index object"
                                                                                       k76)))))))))))
                                                                     i
                                                                     k75))
                                                                  g$x
                                                                  (lambda (rv80)
                                                                    ((cps
                                                                      modulo)
                                                                     rv80
                                                                     2
                                                                     (lambda (rv81)
                                                                       ((lambda (i22
                                                                                 k71)
                                                                          ((cps
                                                                            py-list?)
                                                                           e23
                                                                           (lambda (rv72)
                                                                             (if rv72
                                                                               ((cps
                                                                                 py-list-ref)
                                                                                e23
                                                                                i22
                                                                                k71)
                                                                               ((cps
                                                                                 tuple?)
                                                                                e23
                                                                                (lambda (rv73)
                                                                                  (if rv73
                                                                                    ((cps
                                                                                      tuple-ref)
                                                                                     e23
                                                                                     i22
                                                                                     k71)
                                                                                    ((cps
                                                                                      dict?)
                                                                                     e23
                                                                                     (lambda (rv74)
                                                                                       (if rv74
                                                                                         ((cps
                                                                                           dict-ref)
                                                                                          e23
                                                                                          i22
                                                                                          k71)
                                                                                         (error
                                                                                          "cannot index object"
                                                                                          k71)))))))))))
                                                                        rv81
                                                                        k70))))))
                                                               g$y
                                                               (lambda (rv82)
                                                                 ((cps
                                                                   py-print)
                                                                  rv82
                                                                  k69))))
                                                            k58)
                                                           (k58 (void))))))))))
                                              (lambda (rv59)
                                                ((cps +)
                                                 i
                                                 1
                                                 (lambda (rv60)
                                                   (set-then!
                                                    i
                                                    rv60
                                                    (k57 (void))))))))
                                           k56)))
                                       k55))
                                    k47))
                                 k23)))))
                          k18)
                         (k18 (void)))))))))))
          (void)
          (void)
          k17))
       k16))
    (g$a $halt)))))
